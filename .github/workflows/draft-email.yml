name: Draft Outreach Email

on:
  issues:
    types: [opened]

jobs:
  draft-email:
    if: contains(github.event.issue.title, '[Email]')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Parse email from title
        id: parse
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # Extract everything after [Email] - expects format: [Email] email@domain.com
          INPUT=$(echo "$ISSUE_TITLE" | sed 's/\[Email\]//i' | xargs)
          
          # Check if it looks like an email
          if echo "$INPUT" | grep -qE '@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}'; then
            EMAIL="$INPUT"
            # Extract domain for company research
            DOMAIN=$(echo "$EMAIL" | sed 's/.*@//' | sed 's/\..*//')
            # Extract name from email (before @)
            NAME_PART=$(echo "$EMAIL" | sed 's/@.*//')
            # Convert dots/underscores to spaces and capitalize
            NAME=$(echo "$NAME_PART" | sed 's/[._]/ /g' | sed 's/\b\(.\)/\u\1/g')
          else
            # Fallback: treat as company/contact info
            EMAIL=""
            DOMAIN="$INPUT"
            NAME="there"
          fi
          
          echo "email=$EMAIL" >> $GITHUB_OUTPUT
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "input=$INPUT" >> $GITHUB_OUTPUT
          
          # Save body as additional context
          echo "$ISSUE_BODY" > /tmp/additional_context.txt
      
      - name: Load GTM context
        run: |
          cat CLAUDE.md > /tmp/context.txt 2>/dev/null || true
          cat context/GTM_CONTEXT.md >> /tmp/context.txt 2>/dev/null || true
          cat LINKEDIN_OUTREACH_TEMPLATES.md >> /tmp/context.txt 2>/dev/null || true
          head -c 50000 /tmp/context.txt > /tmp/context_final.txt
      
      - name: Draft email with Claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          EMAIL: ${{ steps.parse.outputs.email }}
          DOMAIN: ${{ steps.parse.outputs.domain }}
          NAME: ${{ steps.parse.outputs.name }}
          INPUT: ${{ steps.parse.outputs.input }}
        run: |
          CONTEXT=$(cat /tmp/context_final.txt | jq -Rs .)
          ADDITIONAL=$(cat /tmp/additional_context.txt | jq -Rs .)
          
          if [ -n "$EMAIL" ]; then
            PROMPT="Draft an outreach email to: **$EMAIL**

            What I know:
            - Email: $EMAIL
            - Likely name: $NAME
            - Company domain: $DOMAIN

            Your task:
            1. First, briefly research what company '$DOMAIN' likely is
            2. Then draft a personalized cold email

            Format your response as:

            ## ðŸ¢ Company Research
            Brief overview of the company (2-3 sentences)

            ## ðŸ“§ Email Draft

            **To:** $EMAIL
            **Subject:** [compelling subject line]

            [email body - under 150 words, personalized, with clear CTA]

            Additional context from user: $ADDITIONAL"
          else
            PROMPT="Draft an outreach email for: **$INPUT**

            Draft a personalized cold email (under 150 words) with clear CTA.

            Format:
            **Subject:** [subject line]

            [email body]

            Additional context: $ADDITIONAL"
          fi
          
          PROMPT_JSON=$(echo "$PROMPT" | jq -Rs .)
          
          RESPONSE=$(curl -s -X POST https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 1200,
              \"messages\": [{\"role\": \"user\", \"content\": $PROMPT_JSON}],
              \"system\": \"You are a B2B sales copywriter for Chroma (AI context layer, 100M+ downloads). Never say 'vector database' - use 'context layer' or 'search infrastructure'. Write concise, personalized emails. No fluff. Context: $CONTEXT\"
            }")
          
          echo "$RESPONSE" | jq -r '.content[0].text // "Error generating email"' > /tmp/email.txt
      
      - name: Post draft to issue
        uses: actions/github-script@v7
        env:
          EMAIL: ${{ steps.parse.outputs.email }}
          INPUT: ${{ steps.parse.outputs.input }}
        with:
          script: |
            const fs = require('fs');
            const email = fs.readFileSync('/tmp/email.txt', 'utf8');
            const recipient = process.env.EMAIL || process.env.INPUT;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ“§ Email Draft\n\n${email}\n\n---\n<sub>ðŸ¤– Generated by Claude | ðŸ’¬ Reply to request changes | âœ… Copy & send when ready</sub>`
            });
