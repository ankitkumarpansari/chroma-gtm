name: Draft Outreach Email

on:
  issues:
    types: [opened]

jobs:
  draft-email:
    if: contains(github.event.issue.title, '[Email]')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Parse email request from title
        id: parse
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # Extract everything after [Email]
          # Examples: "[Email] Notion - Ivan Zhao, CEO" or "[Email] Stripe"
          REQUEST=$(echo "$ISSUE_TITLE" | sed 's/\[Email\]//i' | xargs)
          
          # Try to parse company and contact
          if echo "$REQUEST" | grep -q " - "; then
            COMPANY=$(echo "$REQUEST" | cut -d'-' -f1 | xargs)
            CONTACT_INFO=$(echo "$REQUEST" | cut -d'-' -f2- | xargs)
          else
            COMPANY="$REQUEST"
            CONTACT_INFO="the team"
          fi
          
          echo "company=$COMPANY" >> $GITHUB_OUTPUT
          echo "contact=$CONTACT_INFO" >> $GITHUB_OUTPUT
          echo "request=$REQUEST" >> $GITHUB_OUTPUT
          
          # Include body as additional context if provided
          echo "$ISSUE_BODY" > /tmp/additional_context.txt
      
      - name: Load GTM context
        run: |
          cat CLAUDE.md > /tmp/context.txt 2>/dev/null || true
          cat context/GTM_CONTEXT.md >> /tmp/context.txt 2>/dev/null || true
          cat LINKEDIN_OUTREACH_TEMPLATES.md >> /tmp/context.txt 2>/dev/null || true
          head -c 60000 /tmp/context.txt > /tmp/context_final.txt
      
      - name: Draft email with Claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          COMPANY: ${{ steps.parse.outputs.company }}
          CONTACT: ${{ steps.parse.outputs.contact }}
          REQUEST: ${{ steps.parse.outputs.request }}
        run: |
          CONTEXT=$(cat /tmp/context_final.txt | jq -Rs .)
          ADDITIONAL=$(cat /tmp/additional_context.txt | jq -Rs .)
          
          PROMPT="Draft an outreach email for: $REQUEST

          Company: $COMPANY
          Contact: $CONTACT
          Additional context: $ADDITIONAL

          Write a concise, personalized email (under 150 words).
          Include a clear subject line.
          End with a low-friction CTA.

          Format:
          **Subject:** [subject line]

          [email body]"
          
          PROMPT_JSON=$(echo "$PROMPT" | jq -Rs .)
          
          RESPONSE=$(curl -s -X POST https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 1024,
              \"messages\": [{\"role\": \"user\", \"content\": $PROMPT_JSON}],
              \"system\": \"You are a B2B sales copywriter for Chroma. Never say 'vector database' - use 'context layer'. Be concise and specific. Context: $CONTEXT\"
            }")
          
          echo "$RESPONSE" | jq -r '.content[0].text // "Error generating email"' > /tmp/email.txt
      
      - name: Post draft to issue
        uses: actions/github-script@v7
        env:
          COMPANY: ${{ steps.parse.outputs.company }}
        with:
          script: |
            const fs = require('fs');
            const email = fs.readFileSync('/tmp/email.txt', 'utf8');
            const company = process.env.COMPANY;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ“§ Email Draft for ${company}\n\n${email}\n\n---\n<sub>ðŸ¤– Generated by Claude | ðŸ’¬ Reply to request changes</sub>`
            });
