name: Research Company

on:
  issues:
    types: [opened]

jobs:
  research:
    if: contains(github.event.issue.title, '[Research]')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Extract company name from title
        id: extract
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          COMPANY=$(echo "$ISSUE_TITLE" | sed 's/\[Research\]//i' | xargs)
          echo "company=$COMPANY" >> $GITHUB_OUTPUT
          echo "$ISSUE_BODY" > /tmp/additional_context.txt
      
      - name: Load GTM context
        run: |
          cat context/GTM_CONTEXT.md > /tmp/context.txt 2>/dev/null || true
          cat CHROMA_COMPETITORS.md >> /tmp/context.txt 2>/dev/null || true
          grep -i "${{ steps.extract.outputs.company }}" *.json 2>/dev/null | head -10 >> /tmp/context.txt || true
          head -c 50000 /tmp/context.txt > /tmp/context_final.txt
      
      - name: Research with Claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          COMPANY: ${{ steps.extract.outputs.company }}
        run: |
          CONTEXT=$(cat /tmp/context_final.txt | jq -Rs .)
          ADDITIONAL=$(cat /tmp/additional_context.txt | jq -Rs .)
          
          PROMPT="Research **$COMPANY** as a Chroma prospect.

          Provide:
          ## ğŸ¢ Overview
          What they do, size, key products

          ## ğŸ¤– AI Relevance  
          AI products, use cases, current stack

          ## ğŸ¯ Chroma Fit (1-5)
          ICP fit, use case fit, timing

          ## ğŸ’¡ Outreach Angle
          Best positioning, pain points, who to contact

          ## âš ï¸ Risks
          Any concerns

          Additional context: $ADDITIONAL

          Be specific. If unknown, say so."
          
          PROMPT_JSON=$(echo "$PROMPT" | jq -Rs .)
          
          RESPONSE=$(curl -s -X POST https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 1500,
              \"messages\": [{\"role\": \"user\", \"content\": $PROMPT_JSON}],
              \"system\": \"You are a B2B sales researcher for Chroma. Use 'context layer' not 'vector database'. Context: $CONTEXT\"
            }")
          
          echo "$RESPONSE" | jq -r '.content[0].text // "Error"' > /tmp/research.txt
      
      - name: Post research to issue
        uses: actions/github-script@v7
        env:
          COMPANY: ${{ steps.extract.outputs.company }}
        with:
          script: |
            const fs = require('fs');
            const research = fs.readFileSync('/tmp/research.txt', 'utf8');
            const company = process.env.COMPANY;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ” Research: ${company}\n\n${research}\n\n---\n<sub>ğŸ¤– Generated by Claude | ğŸ“§ Create \`[Email] ${company}\` to draft outreach</sub>`
            });
