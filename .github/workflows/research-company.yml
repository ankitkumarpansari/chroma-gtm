name: Research Company

on:
  issues:
    types: [opened]

jobs:
  research:
    # Only run for company research requests
    if: contains(github.event.issue.title, '[Research]')
    
    runs-on: ubuntu-latest
    
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Extract company name
        id: extract
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # Extract company from title: [Research] Company Name
          COMPANY=$(echo "$ISSUE_TITLE" | sed 's/\[Research\]//i' | xargs)
          echo "company=$COMPANY" >> $GITHUB_OUTPUT
          
          # Get any additional context from body
          echo "$ISSUE_BODY" > /tmp/additional_context.txt
      
      - name: Load GTM context
        run: |
          cat context/GTM_CONTEXT.md > /tmp/context.txt
          cat CHROMA_COMPETITORS.md >> /tmp/context.txt 2>/dev/null || true
          
          # Check if company is in our existing data
          echo "=== EXISTING DATA ===" >> /tmp/context.txt
          grep -i "${{ steps.extract.outputs.company }}" *.json 2>/dev/null | head -20 >> /tmp/context.txt || true
      
      - name: Research company with Claude
        id: research
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          COMPANY: ${{ steps.extract.outputs.company }}
        run: |
          CONTEXT=$(cat /tmp/context.txt | head -c 40000 | jq -Rs .)
          ADDITIONAL=$(cat /tmp/additional_context.txt | jq -Rs .)
          
          PROMPT="Research $COMPANY as a potential Chroma customer/prospect.

          Provide:

          ## ğŸ¢ Company Overview
          - What they do
          - Size/stage (if known)
          - Key products

          ## ğŸ¤– AI/ML Relevance
          - Are they building AI products?
          - What AI use cases might they have?
          - Current tech stack (if known)

          ## ğŸ¯ Chroma Fit Assessment
          Rate 1-5 and explain:
          - **ICP Fit**: Do they match our ideal customer profile?
          - **Use Case Fit**: Would they benefit from Chroma?
          - **Timing**: Are they likely in-market now?

          ## ğŸ’¡ Outreach Angle
          - Best positioning for this company
          - Key pain points to address
          - Suggested entry point (who to contact)

          ## ğŸ”— Key People to Target
          List 2-3 relevant roles/people if known

          ## âš ï¸ Concerns/Risks
          Any red flags or challenges

          Additional context from user: $ADDITIONAL

          Be specific and actionable. If you don't know something, say so."
          
          PROMPT_JSON=$(echo "$PROMPT" | jq -Rs .)
          
          RESPONSE=$(curl -s -X POST https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 2048,
              \"messages\": [{\"role\": \"user\", \"content\": $PROMPT_JSON}],
              \"system\": \"You are a B2B sales researcher for Chroma. Use 'context layer' not 'vector database'. Context: $CONTEXT\"
            }")
          
          RESEARCH=$(echo "$RESPONSE" | jq -r '.content[0].text // "Error researching company"')
          echo "$RESEARCH" > /tmp/research.txt
      
      - name: Post research to issue
        uses: actions/github-script@v7
        env:
          COMPANY: ${{ steps.extract.outputs.company }}
        with:
          script: |
            const fs = require('fs');
            const research = fs.readFileSync('/tmp/research.txt', 'utf8');
            const company = process.env.COMPANY;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ” Research: ${company}\n\n${research}\n\n---\n<sub>ğŸ¤– Generated by Claude</sub>\n<sub>ğŸ’¬ Ask follow-up questions with @claude</sub>\n<sub>ğŸ“§ Ready to reach out? Create an [Email] issue</sub>`
            });
            
            // Add labels
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['research', 'prospect']
            });

