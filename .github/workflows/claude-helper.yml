name: Claude GTM Assistant

# Trigger on new issues or comments containing @claude
on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  respond-to-claude-request:
    # Only run if the issue/comment contains @claude
    if: >-
      (github.event_name == 'issues' && contains(github.event.issue.body, '@claude')) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))
    
    runs-on: ubuntu-latest
    
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Extract the question
        id: extract
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          if [ "$EVENT_NAME" == "issues" ]; then
            QUESTION="$ISSUE_BODY"
          else
            QUESTION="$COMMENT_BODY"
          fi
          
          # Remove @claude from the question
          QUESTION=$(echo "$QUESTION" | sed 's/@claude//gi')
          
          # Save to file to handle special characters
          echo "$QUESTION" > /tmp/question.txt
          echo "Extracted question saved to /tmp/question.txt"
      
      - name: Load GTM context files
        id: context
        run: |
          # Create a combined context file
          echo "=== CLAUDE.md ===" > /tmp/context.txt
          cat CLAUDE.md >> /tmp/context.txt 2>/dev/null || echo "File not found" >> /tmp/context.txt
          
          echo "" >> /tmp/context.txt
          echo "=== GTM_CONTEXT.md ===" >> /tmp/context.txt
          cat context/GTM_CONTEXT.md >> /tmp/context.txt 2>/dev/null || echo "File not found" >> /tmp/context.txt
          
          echo "" >> /tmp/context.txt
          echo "=== MEETING_INDEX.md ===" >> /tmp/context.txt
          cat context/MEETING_INDEX.md >> /tmp/context.txt 2>/dev/null || echo "File not found" >> /tmp/context.txt
          
          echo "" >> /tmp/context.txt
          echo "=== CHROMA_COMPETITORS.md ===" >> /tmp/context.txt
          cat CHROMA_COMPETITORS.md >> /tmp/context.txt 2>/dev/null || echo "File not found" >> /tmp/context.txt
          
          # Truncate if too long (keep under 100k chars for API limits)
          head -c 100000 /tmp/context.txt > /tmp/context_truncated.txt
          mv /tmp/context_truncated.txt /tmp/context.txt
          
          echo "Context loaded successfully"
          wc -c < /tmp/context.txt
      
      - name: Call Claude API
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Read context and question, properly escape for JSON
          CONTEXT=$(cat /tmp/context.txt | jq -Rs .)
          QUESTION=$(cat /tmp/question.txt | jq -Rs .)
          
          # Build the system prompt
          cat > /tmp/system_prompt.txt << 'SYSPROMPT'
          You are the GTM (Go-To-Market) assistant for Chroma, the AI-native embedding database.

          CRITICAL POSITIONING RULES:
          - ALWAYS say "context layer" or "search infrastructure for AI" - NEVER say "vector database"
          - Chroma's positioning: "Better search accuracy ‚Üí lower token costs ‚Üí better, faster, cheaper agents"
          - ICP: Only 2,000-5,000 high-value accounts (high-touch, not volume)

          When answering:
          1. Reference specific documents when relevant
          2. Be concise but thorough
          3. If asked about priorities, check MEETING_INDEX.md for recent decisions
          4. If asked about competitors, reference CHROMA_COMPETITORS.md
          5. Format your response with markdown for readability
          SYSPROMPT
          
          # Append context to system prompt
          echo "" >> /tmp/system_prompt.txt
          echo "You have access to the following context documents:" >> /tmp/system_prompt.txt
          cat /tmp/context.txt >> /tmp/system_prompt.txt
          
          SYSTEM_PROMPT_JSON=$(cat /tmp/system_prompt.txt | jq -Rs .)
          
          # Make API request
          RESPONSE=$(curl -s -X POST https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 4096,
              \"messages\": [{
                \"role\": \"user\",
                \"content\": $QUESTION
              }],
              \"system\": $SYSTEM_PROMPT_JSON
            }")
          
          # Extract the response text
          ANSWER=$(echo "$RESPONSE" | jq -r '.content[0].text // .error.message // "Error: Could not get response from Claude"')
          
          # Save response
          echo "$ANSWER" > /tmp/response.txt
          
          # Debug output
          echo "Response received (first 500 chars):"
          head -c 500 /tmp/response.txt
      
      - name: Post response to issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const response = fs.readFileSync('/tmp/response.txt', 'utf8');
            
            const issueNumber = context.issue.number;
            
            const body = `## ü§ñ Claude Response

            ${response}

            ---
            <sub>üîó Context used: CLAUDE.md, GTM_CONTEXT.md, MEETING_INDEX.md, CHROMA_COMPETITORS.md</sub>
            <sub>üí° Ask follow-up questions by commenting with \`@claude your question\`</sub>`;
            
            await github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
            
            console.log('Response posted successfully!');
      
      - name: Handle errors
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ‚ö†Ô∏è Claude Error

            Sorry, I encountered an error processing your request. This could be due to:
            - Missing API key (check repository secrets)
            - API rate limits
            - Invalid request format

            Please check the workflow logs for details.

            ---
            <sub>If this persists, please contact @ankitkumarpansari</sub>`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
