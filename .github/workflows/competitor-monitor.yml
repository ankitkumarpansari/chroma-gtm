name: Competitor Monitor

# Run every Wednesday at 10am EST (15:00 UTC)
on:
  schedule:
    - cron: '0 15 * * 3'
  workflow_dispatch:  # Manual trigger
  issues:
    types: [opened]

jobs:
  monitor-competitors:
    # Run on schedule OR if issue title contains [Competitor]
    if: >-
      github.event_name == 'schedule' || 
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.issue.title, '[Competitor]')
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Load competitor context
        run: |
          cat CHROMA_COMPETITORS.md > /tmp/competitors.txt 2>/dev/null || echo "No competitor file found"
          cat context/GTM_CONTEXT.md >> /tmp/competitors.txt
      
      - name: Analyze competitors with Claude
        id: analysis
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          IS_ISSUE: ${{ github.event_name == 'issues' }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          CONTEXT=$(cat /tmp/competitors.txt | head -c 60000 | jq -Rs .)
          
          if [ "$IS_ISSUE" == "true" ]; then
            # Specific competitor question from issue
            QUESTION=$(echo "$ISSUE_BODY" | jq -Rs .)
            PROMPT="Answer this competitor question: $QUESTION
            
            Use the competitor context provided. Be specific and actionable."
          else
            # Weekly competitor roundup
            PROMPT="Generate a competitor intelligence brief.

            Based on the competitor context, provide:

            ## ğŸ¯ Key Competitors This Week
            Focus on: Pinecone, Weaviate, Qdrant, TurboPuffer, PGVector

            ## ğŸ“Š Positioning Comparison
            How is each competitor positioning themselves vs Chroma?

            ## ğŸš¨ Threats to Watch
            Any concerning moves or announcements?

            ## ğŸ’¡ Opportunities
            Where can Chroma differentiate or win?

            ## ğŸ¬ Recommended Actions
            2-3 specific things we should do this week

            Be concise but insightful. Reference specific details from the context."
          fi
          
          PROMPT_JSON=$(echo "$PROMPT" | jq -Rs .)
          
          RESPONSE=$(curl -s -X POST https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 2048,
              \"messages\": [{\"role\": \"user\", \"content\": $PROMPT_JSON}],
              \"system\": \"You are a competitive intelligence analyst for Chroma. Never say 'vector database' - use 'context layer'. Context: $CONTEXT\"
            }")
          
          ANALYSIS=$(echo "$RESPONSE" | jq -r '.content[0].text // "Error generating analysis"')
          echo "$ANALYSIS" > /tmp/analysis.txt
      
      - name: Post to issue or create new
        uses: actions/github-script@v7
        env:
          IS_ISSUE: ${{ github.event_name == 'issues' }}
        with:
          script: |
            const fs = require('fs');
            const analysis = fs.readFileSync('/tmp/analysis.txt', 'utf8');
            const isIssue = process.env.IS_ISSUE === 'true';
            
            if (isIssue) {
              // Comment on existing issue
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ” Competitor Analysis\n\n${analysis}\n\n---\n<sub>ğŸ¤– Generated by Claude</sub>`
              });
            } else {
              // Create new issue for weekly roundup
              const date = new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ” Competitor Intel Brief - ${date}`,
                body: `${analysis}\n\n---\n<sub>ğŸ¤– Auto-generated every Wednesday</sub>\n<sub>ğŸ’¬ Comment with @claude for specific competitor questions</sub>`,
                labels: ['competitor-intel', 'automated']
              });
            }

