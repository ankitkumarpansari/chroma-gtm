name: Competitor Intel

on:
  schedule:
    - cron: '0 15 * * 3'  # Wednesdays 10am EST
  workflow_dispatch:
  issues:
    types: [opened]

jobs:
  analyze:
    if: >-
      github.event_name == 'schedule' || 
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.issue.title, '[Competitor]')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Parse request
        id: parse
        env:
          IS_ISSUE: ${{ github.event_name == 'issues' }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          echo "is_issue=$IS_ISSUE" >> $GITHUB_OUTPUT
          if [ "$IS_ISSUE" == "true" ]; then
            QUESTION=$(echo "$ISSUE_TITLE" | sed 's/\[Competitor\]//i' | xargs)
            echo "question=$QUESTION" >> $GITHUB_OUTPUT
          fi
          echo "$ISSUE_BODY" > /tmp/additional_context.txt
      
      - name: Load competitor context
        run: |
          cat CHROMA_COMPETITORS.md > /tmp/context.txt 2>/dev/null || true
          cat context/GTM_CONTEXT.md >> /tmp/context.txt 2>/dev/null || true
          head -c 60000 /tmp/context.txt > /tmp/context_final.txt
      
      - name: Analyze with Claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          IS_ISSUE: ${{ steps.parse.outputs.is_issue }}
          QUESTION: ${{ steps.parse.outputs.question }}
        run: |
          CONTEXT=$(cat /tmp/context_final.txt | jq -Rs .)
          ADDITIONAL=$(cat /tmp/additional_context.txt | jq -Rs .)
          
          if [ "$IS_ISSUE" == "true" ]; then
            PROMPT="Answer this competitor question: **$QUESTION**

            Additional context: $ADDITIONAL

            Be specific and actionable. Reference our positioning."
          else
            PROMPT="Generate a competitor intelligence brief.

            ## üéØ Key Competitors
            Pinecone, Weaviate, Qdrant, TurboPuffer, PGVector

            ## üìä Positioning Comparison
            ## üö® Threats to Watch
            ## üí° Opportunities
            ## üé¨ Recommended Actions

            Be concise but insightful."
          fi
          
          PROMPT_JSON=$(echo "$PROMPT" | jq -Rs .)
          
          RESPONSE=$(curl -s -X POST https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 1500,
              \"messages\": [{\"role\": \"user\", \"content\": $PROMPT_JSON}],
              \"system\": \"You are a competitive intelligence analyst for Chroma. Use 'context layer' not 'vector database'. Context: $CONTEXT\"
            }")
          
          echo "$RESPONSE" | jq -r '.content[0].text // "Error"' > /tmp/analysis.txt
      
      - name: Post to issue
        uses: actions/github-script@v7
        env:
          IS_ISSUE: ${{ steps.parse.outputs.is_issue }}
          QUESTION: ${{ steps.parse.outputs.question }}
        with:
          script: |
            const fs = require('fs');
            const analysis = fs.readFileSync('/tmp/analysis.txt', 'utf8');
            const isIssue = process.env.IS_ISSUE === 'true';
            
            if (isIssue) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ‚öîÔ∏è Competitor Intel\n\n${analysis}\n\n---\n<sub>ü§ñ Generated by Claude</sub>`
              });
            } else {
              const date = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `‚öîÔ∏è Competitor Brief - ${date}`,
                body: `${analysis}\n\n---\n<sub>ü§ñ Auto-generated weekly</sub>`,
                labels: ['competitor-intel', 'automated']
              });
            }
