name: Draft LinkedIn Post

on:
  issues:
    types: [opened]

jobs:
  draft-post:
    if: contains(github.event.issue.title, '[LinkedIn]')
    
    runs-on: ubuntu-latest
    
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Extract topic
        id: extract
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          TOPIC=$(echo "$ISSUE_TITLE" | sed 's/\[LinkedIn\]//i' | xargs)
          echo "topic=$TOPIC" >> $GITHUB_OUTPUT
          echo "$ISSUE_BODY" > /tmp/context.txt
      
      - name: Load content context
        run: |
          cat LINKEDIN_CONTENT_CALENDAR.md >> /tmp/context.txt 2>/dev/null || true
          cat context/GTM_CONTEXT.md >> /tmp/context.txt
      
      - name: Draft post with Claude
        id: draft
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TOPIC: ${{ steps.extract.outputs.topic }}
        run: |
          CONTEXT=$(cat /tmp/context.txt | head -c 30000 | jq -Rs .)
          
          PROMPT="Draft a LinkedIn post about: $TOPIC

          RULES:
          - Write for a technical but accessible audience
          - Keep it under 1300 characters (LinkedIn limit)
          - Use line breaks for readability
          - Include a hook in the first line
          - End with a question or CTA to drive engagement
          - NO hashtags in the main text (add separately)
          - Sound authentic, not corporate
          - Reference Chroma naturally if relevant (as 'context layer' not 'vector database')

          Provide:

          ## ğŸ“ Post Draft
          [The actual post text]

          ## ğŸ£ Alternative Hooks
          3 alternative opening lines

          ## #ï¸âƒ£ Suggested Hashtags
          5-7 relevant hashtags

          ## ğŸ“Š Post Type
          Is this: Thought leadership / Product update / Industry insight / Personal story

          ## ğŸ• Best Time to Post
          Suggest optimal posting time"
          
          PROMPT_JSON=$(echo "$PROMPT" | jq -Rs .)
          
          RESPONSE=$(curl -s -X POST https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 1500,
              \"messages\": [{\"role\": \"user\", \"content\": $PROMPT_JSON}],
              \"system\": \"You are a LinkedIn content strategist for a B2B AI infrastructure company. Write engaging, authentic posts. Context: $CONTEXT\"
            }")
          
          POST=$(echo "$RESPONSE" | jq -r '.content[0].text // "Error drafting post"')
          echo "$POST" > /tmp/post.txt
      
      - name: Post draft to issue
        uses: actions/github-script@v7
        env:
          TOPIC: ${{ steps.extract.outputs.topic }}
        with:
          script: |
            const fs = require('fs');
            const post = fs.readFileSync('/tmp/post.txt', 'utf8');
            const topic = process.env.TOPIC;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ“± LinkedIn Post Draft: ${topic}\n\n${post}\n\n---\n### âœï¸ Next Steps\n1. Review and edit the draft\n2. Copy to LinkedIn\n3. Add your personal touch\n4. Post at suggested time!\n\n---\n<sub>ğŸ¤– Generated by Claude</sub>\n<sub>ğŸ’¬ Want revisions? Comment with feedback</sub>`
            });
            
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['content', 'linkedin', 'draft-ready']
            });

