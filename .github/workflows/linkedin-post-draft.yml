name: Draft LinkedIn Post

on:
  issues:
    types: [opened]

jobs:
  draft-post:
    if: contains(github.event.issue.title, '[LinkedIn]')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Extract topic from title
        id: extract
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          TOPIC=$(echo "$ISSUE_TITLE" | sed 's/\[LinkedIn\]//i' | xargs)
          echo "topic=$TOPIC" >> $GITHUB_OUTPUT
          echo "$ISSUE_BODY" > /tmp/additional_context.txt
      
      - name: Load content context
        run: |
          cat LINKEDIN_CONTENT_CALENDAR.md > /tmp/context.txt 2>/dev/null || true
          cat context/GTM_CONTEXT.md >> /tmp/context.txt 2>/dev/null || true
          head -c 30000 /tmp/context.txt > /tmp/context_final.txt
      
      - name: Draft post with Claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TOPIC: ${{ steps.extract.outputs.topic }}
        run: |
          CONTEXT=$(cat /tmp/context_final.txt | jq -Rs .)
          ADDITIONAL=$(cat /tmp/additional_context.txt | jq -Rs .)
          
          PROMPT="Draft a LinkedIn post about: **$TOPIC**

          Rules:
          - Under 1300 characters
          - Strong hook in first line
          - Use line breaks for readability
          - End with question or CTA
          - Sound authentic, not corporate
          - Reference Chroma as 'context layer' if relevant

          Provide:
          ## ðŸ“ Post
          [the post]

          ## ðŸŽ£ Alt Hooks
          3 alternative opening lines

          ## #ï¸âƒ£ Hashtags
          5-7 hashtags

          Additional context: $ADDITIONAL"
          
          PROMPT_JSON=$(echo "$PROMPT" | jq -Rs .)
          
          RESPONSE=$(curl -s -X POST https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 1200,
              \"messages\": [{\"role\": \"user\", \"content\": $PROMPT_JSON}],
              \"system\": \"You are a LinkedIn content strategist. Write engaging, authentic posts. Context: $CONTEXT\"
            }")
          
          echo "$RESPONSE" | jq -r '.content[0].text // "Error"' > /tmp/post.txt
      
      - name: Post draft to issue
        uses: actions/github-script@v7
        env:
          TOPIC: ${{ steps.extract.outputs.topic }}
        with:
          script: |
            const fs = require('fs');
            const post = fs.readFileSync('/tmp/post.txt', 'utf8');
            const topic = process.env.TOPIC;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ“± LinkedIn Post: ${topic}\n\n${post}\n\n---\n<sub>ðŸ¤– Generated by Claude | ðŸ’¬ Reply to request changes</sub>`
            });
